<!-- Updated SCENE MANAGER section with async handling and initialization checks -->

<script>
let valvesInitialized = false;
let flowBlueInitialized = false;
let flowRedInitialized = false;

async function buildScenes() {
    // Assuming buildHeartScene, buildLungsScene, etc. are your scene build functions
    await buildHeartScene();
    await buildLungsScene();
    valvesInitialized = true;
    flowBlueInitialized = true;
    flowRedInitialized = true;
}

function update() {
    if (valvesInitialized) {
        // Safely access valves
        if (valves && valves.children) {
            // Update logic here
        }
    }
    // Add similar checks for flowBlue and flowRed
}

async function init() {
    await buildScenes();
    // Any other initialization logic
}

init();
</script>

<!-- The rest of your index.html content -->